@{
    Layout = null;
    ViewData["Title"] = "Login";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - Volet</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        :root{
            --bg:#0b0f14;
            --panel:#0f1720;
            --panel2:#0d141c;
            --line:rgba(255,255,255,.10);
            --text:rgba(255,255,255,.92);
            --muted:rgba(255,255,255,.62);
            --muted2:rgba(255,255,255,.42);
            --accent:#28e0a3;
        }

        html,body{height:100%}
        body{
            margin:0;
            font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            background: radial-gradient(1200px 600px at 50% -20%, rgba(40,224,163,.10), transparent 55%), var(--bg);
            color:var(--text);
        }
        a{color:var(--accent);text-decoration:none}
        a:hover{text-decoration:underline;color:var(--accent)}

        .auth-shell{min-height:100%;display:flex;flex-direction:column}
        .topbar{padding:28px 40px}
        .brand{font-weight:800;letter-spacing:.4px;font-size:28px;color:#fff}

        .auth-main{flex:1;display:flex;align-items:center;justify-content:center;padding:24px 18px 40px}
        .auth-grid{
            width:min(1120px,100%);
            display:grid;
            grid-template-columns:1fr;
            gap:34px;
            align-items:start;
        }
        @@media (min-width:992px){
            .auth-grid{grid-template-columns:1.05fr .95fr}
        }

        .headline{
            font-size:clamp(34px,3.2vw,50px);
            font-weight:800;
            margin:0 0 18px 0;
            letter-spacing:-.02em;
        }

        .panel{
            background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
            border:1px solid var(--line);
            border-radius:16px;
            padding:28px;
            box-shadow:0 20px 60px rgba(0,0,0,.35);
        }

        .form-label{
            color:var(--muted2);
            font-size:12px;
            letter-spacing:.08em;
            text-transform:uppercase;
            margin-bottom:8px;
        }
        .field{
            width:100%;
            background:transparent;
            border:1px solid var(--line);
            color:var(--text);
            padding:12px 14px;
            border-radius:10px;
            outline:none;
        }
        .field:focus{border-color:rgba(40,224,163,.6);box-shadow:0 0 0 3px rgba(40,224,163,.12)}

        .muted-link{color:var(--accent);font-weight:600;font-size:14px}

        .btn-auth{
            width:100%;
            border-radius:10px;
            padding:12px 14px;
            font-weight:700;
            letter-spacing:.02em;
            border:1px solid rgba(255,255,255,.12);
            background:rgba(255,255,255,.18);
            color:rgba(255,255,255,.72);
            cursor:pointer;
            transition: all 0.2s ease;
        }
        .btn-auth:hover{filter:brightness(1.05)}
        .btn-auth:disabled{opacity:.65;cursor:not-allowed}
        .btn-auth.btn-primary{
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }

        .below{
            margin-top:14px;
            color:var(--muted);
            text-align:center;
        }

        .info-card{
            background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
            border:1px solid var(--line);
            border-radius:16px;
            padding:22px;
        }
        .info-title{font-weight:800;margin:0 0 8px 0}
        .info-text{color:var(--muted);margin:0;line-height:1.55}

        .footer{
            border-top:1px solid var(--line);
            padding:18px 40px;
            color:var(--muted2);
            font-size:12px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:14px;
            flex-wrap:wrap;
        }
        .footer-links{display:flex;gap:18px;flex-wrap:wrap}
        .badge-row{display:flex;gap:18px;align-items:center;opacity:.7}
        .badge{
            border:1px solid var(--line);
            padding:6px 10px;
            border-radius:999px;
            font-weight:700;
            letter-spacing:.02em;
            color:rgba(255,255,255,.72);
        }

        /* 2FA Section Styles */
        .two-factor-section{display:none}
        .two-factor-section.active{display:block}
        
        .otp-input{
            font-size:32px;
            letter-spacing:12px;
            text-align:center;
            font-weight:700;
        }

        .check-email-icon{
            width:80px;
            height:80px;
            background:rgba(40,224,163,.15);
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            margin:0 auto 20px;
        }
        .check-email-icon svg{
            width:40px;
            height:40px;
            color:var(--accent);
        }

        /* Back button */
        .back-btn{
            display:inline-flex;
            align-items:center;
            gap:6px;
            color:var(--muted);
            font-size:14px;
            margin-bottom:16px;
            cursor:pointer;
            border:none;
            background:none;
        }
        .back-btn:hover{color:var(--text)}
    </style>
</head>

<body>
    <div class="auth-shell">
        <div class="topbar">
            <div class="brand">volet</div>
        </div>

        <div class="auth-main">
            <div class="auth-grid">
                <!-- LEFT: FORM -->
                <div>
                    <h1 class="headline" id="pageTitle">Login</h1>

                    <!-- Login Form Section -->
                    <div id="loginSection" class="two-factor-section active">
                        <div class="panel">
                            <form id="loginForm" autocomplete="off">
                                <div class="mb-3">
                                    <div class="form-label">Email</div>
                                    <input class="field" type="email" id="email" placeholder="" required />
                                </div>

                                <div class="mb-2">
                                    <div class="form-label">Password</div>
                                    <input class="field" type="password" id="password" placeholder="" required />
                                </div>

                                <div class="mb-3">
                                    <a class="muted-link" href="#" onclick="return false;">Forgot password?</a>
                                </div>

                                <button class="btn-auth btn-primary" id="loginBtn" type="submit">LOG IN</button>

                                <div class="below">
                                    Don't have an account yet?
                                    <a href="/register">Sign up for free!</a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- TOTP Entry Section -->
                    <div id="totpSection" class="two-factor-section">
                        <button class="back-btn" onclick="showLoginSection()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                            Back
                        </button>
                        <div class="panel">
                            <h3 style="color:#fff;margin:0 0 8px 0;font-weight:700">Token</h3>
                            <p style="color:var(--muted);margin:0 0 24px 0;font-size:14px">
                                To login, please enter your one-time password from mobile token
                            </p>
                            <div class="mb-3">
                                <div class="form-label">One-Time Password</div>
                                <input class="field otp-input" type="text" id="totpCode" maxlength="6" placeholder="" required pattern="[0-9]{6}" />
                            </div>
                            <button class="btn-auth btn-primary" id="verifyTotpBtn" type="button" onclick="verifyTotp()">CONTINUE</button>
                        </div>
                    </div>

                    <!-- Email Magic Link Section -->
                    <div id="emailSection" class="two-factor-section">
                        <button class="back-btn" onclick="showLoginSection()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                            Back
                        </button>
                        <div class="panel" style="text-align:center">
                            <div class="check-email-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                            </div>
                            <h3 style="color:#fff;margin:0 0 12px 0;font-weight:700">Check Your Email</h3>
                            <p style="color:var(--muted);margin:0 0 8px 0;font-size:14px">
                                We've sent a login link to your email address.
                            </p>
                            <p style="color:var(--muted2);margin:0;font-size:13px">
                                Click the link in the email to complete your login. The link will expire in 15 minutes.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: INFO CARD -->
                <div class="info-card">
                    <h3 class="info-title">Create free crypto wallets instantly!</h3>
                    <p class="info-text">
                        Volet.com has crypto wallets! Store, send, receive BTC, ETH, USDT, USDC and other crypto,
                        quickly buy and sell coins, pay and get paid in crypto, send and receive free P2P crypto
                        transfers within Volet.com! Click + on the left and create a crypto wallet for free.
                    </p>
                </div>
            </div>
        </div>

        <div class="footer">
            <div>
                Queensland Foreign Exchange Inc. — Toronto, Ontario, Canada<br />
                Second February Limitada — Republic of Costa Rica<br />
                © 2025 Volet.com
            </div>

            <div class="footer-links">
                <a href="#" onclick="return false;">Cookies Policy</a>
                <a href="#" onclick="return false;">AML Program</a>
                <a href="#" onclick="return false;">Privacy Policy</a>
                <a href="#" onclick="return false;">Terms and Conditions</a>
            </div>

            <div class="badge-row">
                <span class="badge">PCI DSS</span>
                <span class="badge">Mastercard</span>
                <span class="badge">VISA</span>
            </div>
        </div>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // State
        let challengeToken = '';
        let userEmail = '';

        // Toast configuration for SweetAlert2
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 4000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        // Handle URL parameters on page load
        (function () {
            const qp = new URLSearchParams(window.location.search);
            
            // Email confirmation messages
            if (qp.get('emailConfirmed') === 'success') {
                Toast.fire({
                    icon: 'success',
                    title: 'Email confirmed successfully!',
                    text: 'Please login to continue.'
                });
                // Clean URL
                window.history.replaceState({}, document.title, '/login');
            } else if (qp.get('emailConfirmed') === 'already') {
                Toast.fire({
                    icon: 'info',
                    title: 'Email already confirmed',
                    text: 'You can login now.'
                });
                window.history.replaceState({}, document.title, '/login');
            }

            // Error messages
            if (qp.get('error')) {
                const errorMessages = {
                    'invalid_token': 'Invalid or expired link. Please try again.',
                    'user_not_found': 'User not found. Please register first.',
                    'token_expired': 'Link has expired. Please request a new one.',
                    'confirmation_failed': 'Email confirmation failed. Please try again.'
                };
                const errorMsg = errorMessages[qp.get('error')] || 'An error occurred. Please try again.';
                Toast.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMsg
                });
                window.history.replaceState({}, document.title, '/login');
            }

            // Magic login success
            if (qp.get('magicLogin') === 'success' && qp.get('token')) {
                localStorage.setItem('volet_token', qp.get('token'));
                Toast.fire({
                    icon: 'success',
                    title: 'Login successful!',
                    text: 'Redirecting...'
                });
                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);
            }
        })();

        function showLoginSection() {
            document.getElementById('loginSection').classList.add('active');
            document.getElementById('totpSection').classList.remove('active');
            document.getElementById('emailSection').classList.remove('active');
            document.getElementById('pageTitle').textContent = 'Login';
            challengeToken = '';
        }

        function showTotpSection() {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('totpSection').classList.add('active');
            document.getElementById('emailSection').classList.remove('active');
            document.getElementById('pageTitle').textContent = 'Token';
            document.getElementById('totpCode').focus();
        }

        function showEmailSection() {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('totpSection').classList.remove('active');
            document.getElementById('emailSection').classList.add('active');
            document.getElementById('pageTitle').textContent = 'Check Email';
        }

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('loginBtn');
            btn.disabled = true;

            try {
                userEmail = document.getElementById('email').value.trim();
                const payload = {
                    email: userEmail,
                    password: document.getElementById('password').value
                };

                const res = await fetch('/api/Auth/login-challenge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json().catch(() => ({}));

                if (!res.ok) {
                    Toast.fire({
                        icon: 'error',
                        title: 'Login Failed',
                        text: data?.message || data?.Message || 'Invalid email or password.'
                    });
                    return;
                }

                // Check if 2FA is required
                if (data.requiresTwoFactor) {
                    challengeToken = data.challengeToken;
                    
                    if (data.twoFactorMethod === 'Authenticator') {
                        showTotpSection();
                    } else {
                        showEmailSection();
                        Toast.fire({
                            icon: 'info',
                            title: 'Login Link Sent',
                            text: 'Check your email for the login link.'
                        });
                    }
                } else {
                    // No 2FA - store token and redirect
                    if (data.token) {
                        localStorage.setItem('volet_token', data.token);
                    }
                    window.location.href = '/';
                }
            } catch (err) {
                Toast.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Login failed. Please try again.'
                });
            } finally {
                btn.disabled = false;
            }
        });

        // Verify TOTP code
        async function verifyTotp() {
            const btn = document.getElementById('verifyTotpBtn');
            const code = document.getElementById('totpCode').value.trim();

            if (code.length !== 6) {
                Toast.fire({
                    icon: 'warning',
                    title: 'Invalid Code',
                    text: 'Please enter a 6-digit code.'
                });
                return;
            }

            btn.disabled = true;

            try {
                const res = await fetch('/api/Auth/verify-totp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: userEmail,
                        code: code,
                        challengeToken: challengeToken
                    })
                });

                const data = await res.json().catch(() => ({}));

                if (!res.ok) {
                    Toast.fire({
                        icon: 'error',
                        title: 'Verification Failed',
                        text: data?.message || data?.Message || 'Invalid verification code.'
                    });
                    document.getElementById('totpCode').value = '';
                    document.getElementById('totpCode').focus();
                    return;
                }

                // Success - store token and redirect
                if (data.token) {
                    localStorage.setItem('volet_token', data.token);
                }

                Toast.fire({
                    icon: 'success',
                    title: 'Login Successful!',
                    text: 'Redirecting...'
                });

                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);
            } catch (err) {
                Toast.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Verification failed. Please try again.'
                });
            } finally {
                btn.disabled = false;
            }
        }

        // Allow Enter key to submit TOTP
        document.getElementById('totpCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                verifyTotp();
            }
        });

        // Only allow numbers in TOTP input
        document.getElementById('totpCode').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 6);
        });
    </script>
</body>
</html>